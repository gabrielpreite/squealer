<!DOCTYPE html>
<html lang="en-US">

  <head>
    <title>Squealer</title>

    <!----BOOSTRAP-->
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">

    <!--Font Awesome-->
    <script src="https://kit.fontawesome.com/352b6e21d2.js" crossorigin="anonymous"></script>

    <!--Chart.js-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>

    <!--chart.js-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <!--Adattatore date-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.23.0/date-fns.min.js"></script>

    <!--Fonts-->
    <link href="http://fonts.cdnfonts.com/css/chirp-2" rel="stylesheet">

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.16.3.min.js"></script>

    <!--JavaScript Scripts-->
    <script type="text/javascript" src="../js/global.js"></script>
    <script type="text/javascript" src="../js/feed.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="../css/feed.css">
    <link rel="stylesheet" href="../css/navbar.css">

  </head>
  <body>
    <header>
      <div class="navbar fixed-top">
        <div id="profile">
          <img src="https://via.placeholder.com/60x60" alt="Profile picture" id="propic">
          <div class="dropdown" id="username">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <strong>
              <script>
                document.write(get_cookie_by_name("username"))
              </script>
            </strong>
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="dropdown-account-smm">
              <h6 class="dropdown-header">Gestisci altri account</h6>
            </div>
          </div>
          <div id="managed-account-username" class="btn btn-primary" onclick="switch_to_smm()" hidden="true"></div>
        </div>
        <div id="quota">
          <div class="char-count-item">
            <span class="count" id="charCount_mese">

            </span>
            <span class="label">Mese</span>
          </div>
          <div class="char-count-item">
            <span class="count" id="charCount_sett">

            </span>
            <span class="label">Settimana</span>
          </div>
          <div class="char-count-item">
            <span class="count" id="charCount_giorno">

            </span>
            <span class="label">Giorno</span>
          </div>
      <button class="btn btn-unstyled" id="shopButton">
    <i class="fas fa-shopping-cart"></i>
  </button>
    </div>
    <div class="lateral-buttons">
      <div id="notifiche">
      <button class="btn btn-unstyled" id="notificationsButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <i class="fas fa-bell"></i>
      </button>
      <div class="dropdown-menu dropdown-menu-end" id="notificationsDropdown" aria-labelledby="notificationsButton">
        <h3 class="dropdown-header">Notifiche</h3>
      </div>
    </div>
    <!-- VERSIONE HOME
    <div id="home">
      <button class="btn btn-unstyled" id="homeButton">
        <i class="fas fa-home"></i>
      </button>
    </div>
      -->
    <div id="impostazioni">
      <button class="btn btn-unstiled" id="settingsButton" onclick="redirectToSettings()">
        <i class="fas fa-cog"></i>
      </button>
    </div>
    </div>
    <script type="text/javascript">
      // Assegna i valori alle variabili
      let quota_giorno = get_cookie_by_name("quota_giorno");
      let quota_settimana = get_cookie_by_name("quota_settimana");
      let quota_mese = get_cookie_by_name("quota_mese");

      // Aggiorna il contenuto delle span con i nuovi valori
      document.getElementById("charCount_mese").textContent = quota_mese;
      document.getElementById("charCount_sett").textContent = quota_settimana;
      document.getElementById("charCount_giorno").textContent = quota_giorno;
    </script>

      </div>
    </header>

    <body>

      <!--PULSANTE NUOVO SQUEAL-->
      <div class="fixed-button" id="nuovo-squeal">
        <button class="round-button" onclick="redirectToEditor()">
          +
        </button>
      </div>

        <!-- First Column -->
        <div class="col-md-3 barra-scorrimento" id="col-sx">
          <div class="social-channels">
            <a href="" class="channel-button" style="margin-left: 15px"><i class="fas fa-wrench"></i> Staff</a>
            <a href="" class="channel-button"><i class="far fa-newspaper fa-fw"></i> News</a>
            <a href="" class="channel-button" style="margin-right: 5px;"><i class="far fa-sun"></i> Meteo</a>
          </div>

          <h4 class="statistiche-title" style="text-align: left">Tendenze</h4>
          <ol class="tendenze-list">
            <li class="tendenze-item">
              <span class="tendenze-tag"><a href="#">#hashtag</a></span>
              <span class="tendenze-count">100k Squeals</span>
            </li>
            <li class="tendenze-item">
              <span class="tendenze-tag"><a href="#">#hashtag</a></span>
              <span class="tendenze-count">80k Squeals</span>
            </li>
            <li class="tendenze-item">
              <span class="tendenze-tag"><a href="#">#hashtag</a></span>
              <span class="tendenze-count">50k Squeals</span>
            </li>
            <li class="tendenze-item">
              <span class="tendenze-tag"><a href="#">#hashtag</a></span>
              <span class="tendenze-count">40k Squeals</span>
            </li>
            <li class="tendenze-item">
              <span class="tendenze-tag"><a href="#">#hashtag</a></span>
              <span class="tendenze-count">30k Squeals</span>
            </li>
          </ol>

          <h4 class="statistiche-title">Trend</h4>
          <div class="grafico mosaic-container">
              <!-- Le tessere del mosaico saranno generate dinamicamente con JavaScript -->
          </div>

          <h4 class="statistiche-title">Cronologia Squeal</h4>
          <div class="grafico" id="grafico-squeal">
            <canvas id="squealChart"></canvas>
          </div>

          <h4 class="statistiche-title">Andamento Popolarità</h4>
          <div class="grafico" id="grafico-popolarità">
            <canvas id="popolaritaChart"></canvas>
          </div>

          <h4 class="statistiche-title">Numero Commenti</h4>
            <div class="grafico" id="grafico-commenti">
                <canvas id="commentiChart"></canvas>
            </div>

          <br><br>

        </div>

        <!-- Second Column -->
        <div class="col-md-6" id="feed">

          <div class="searchbar">
            <div class="barra">
              <form id="form_ricerca">
                <div class="input-group mb-3">
                  <select class="form-select" id="tipo" name="tipo" aria-label="Select">
                    <option selected value="utente" id="utente">
                      @</option>
                    <option value="canale" id="canale">
                      $</option>
                    <option value="keyword" id="keyword">
                      #</option>
                  </select>

                  <input class="form-control input-sm searchbar-style" type="text" placeholder="Search" name="query" id="query">

                  <select class="form-select" id="filtro" name="filtro" aria-label="Select" onchange="rimpiazza_squeals(squeals, this.value)">
                    <option selected value="data" id="data">
                      Data</option>
                    <option value="visual" id="visual">
                      Numero di visualizzazioni</option>
                    <option value="impression" id="impression">
                      Impression</option>
                  </select>

                  <button type="submit" class="btn searchbar-style" style="color: #1d9bf0;
                    border-color: #1d9bf0;"><em class="fa-solid fa-magnifying-glass"></em>Cerca</button>
                </div>
              </form>
            </div>
          </div>

          <div class="contenitore-squeal posts-content barra-scorrimento" id="squeal_contenitore">



          </div>

        </div>

        <!-- Third Column -->
        <div class="col-md-3" id="col-dx">
          <div id="barra-destra" class="container">

          </div>
          <div id="mostra-commenti" hidden="true">
            <h4 class="statistiche-title">Commenti<i class="fa-solid fa-times icona-chiudi" onclick="aggiungicommento(this, 'chiudi')"></i></h4>
            <div class="contenitore-commenti barra-scorrimento" id="contenitore-commenti">
              <div class="comment">
                <img src="https://via.placeholder.com/48x48" alt="Profile Image" class="comment-profile-image">
                <div class="comment-content">
                  <strong class="comment-username">Nome Utente</strong>
                  <p class="comment-text">Questo è un commento.</p>
                </div>
              </div>
              <div class="comment">
                <img src="https://via.placeholder.com/48x48" alt="Profile Image" class="comment-profile-image">
                <div class="comment-content">
                  <strong class="comment-username">Nome Utente</strong>
                  <p class="comment-text">Questo è un commento.</p>
                </div>
              </div>

            </div>
            <div class="">
              <button class="btn btn-primary aggiungi-commento" onclick="aggiungicommento(this, 'commenta', this.id)">
                Commenta   <i class="fa-solid fa-comment-dots icona-commento"></i>
              </button>
            </div>
          </div>
        </div>

      <!--JQuery-->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
      <!-- JavaScript Bundle with Popper -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>

      <script>
        document.getElementById("form_ricerca").addEventListener('submit', async event => {
          event.preventDefault();
          let result = ricerca_squeal(null);
          squeals = result.post;
          var info_ricerca = result.meta;
        });

        // INSERIMENTO PROPIC UTENTE
        $("#propic").attr("src", "http://site212251.tw.cs.unibo.it/uploads/"+get_cookie_by_name("img"))

        // INSERIMENTO ACCOUNT GESTITI DA SMM
        let account = []
        $.ajax({
          type: 'GET',
          dataType: "json",
          async: false,
          url: `https://site212251.tw.cs.unibo.it/get_managed`,
          headers: { },
          success: function (data, status, xhr) {
            console.log('data: ', data);
            account = data;
          }
        });

        account.forEach((el) => {
          $("#dropdown-account-smm").append(`<button class="dropdown-item" type="button" onclick="switch_account('${el}')">${el}</button>`)
        })

        //se sto gestendo un account lo mostro nella barra
        let managed = get_cookie_by_name("managed")
        if(!(managed === undefined)){
          $("#managed-account-username").text(managed)
          $("#managed-account-username").removeAttr("hidden")
        }

        //aggiunta e gestione notifiche
        var account_now = get_cookie_by_name("managed");
        if (account_now == undefined) {
          account_now = get_cookie_by_name("username");
        }
        var notifiche;
        $.ajax({
          type: 'GET',
          dataType: "json",
          async: false,
          url: `https://site212251.tw.cs.unibo.it/get_notifiche?username=${account_now}`,
          headers: { },
          success: function (data, status, xhr) {
            notifiche = data;
          }
        });
        var lista_notifiche = document.getElementById('notificationsDropdown');
        var n_notifiche = notifiche.length;
        for (var n = 0; n < n_notifiche; n++) {
          //costruzione notifica
          var not_tipo = 'type="button" ';
          var not_id = 'id="' + notifiche[n].not_id + '" ';
          var not_class = 'class="dropdown-item ';
          if (notifiche[n].letta) {
            not_class = not_class + 'letta ';
          } else {
            not_class = not_class + 'not_letta ';
          }
          not_class = not_class + notifiche[n].tipo + '" ';
          var on_click = 'onclick="ricerca_notifica(notifiche[' + n + '])"';

          var notifica = '<a ' + not_tipo + not_id + not_class + on_click + '>' + notifiche[n].testo + '</a>';
          lista_notifiche.insertAdjacentHTML('beforeend', notifica);
        }



        //RICHIESTA E COSTRUZIONE SQUEAL
        var squeals;
        $.ajax({
          type: 'GET',
          dataType: "json",
          async: false,
          url: `https://site212251.tw.cs.unibo.it/user_feed`,
          headers: { },
          success: function (data, status, xhr) {
            console.log('data: ', data);
            squeals = data;
          }
        });

        //setup
        var adoro = "adoro";
        var mi_disgusta = "mi_disgusta";
        var mi_piace = "mi_piace";
        var odio = "odio";
        var concordo = "concordo";
        var sono_contrario = "sono_contrario";
        var apri = "apri";
        aggiungi_squeal(squeals);
/*
        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
          var data = google.visualization.arrayToDataTable([
            ['Orario', 'Utenti'],
            [00, 120],
            [02, 80],
            [05, 150],
            [08, 250],
            [12, 320],
            [16, 280],
            [19, 200],
            [22, 180],
          ]);

          var options = {
            height: 200,
            width: 305.4,
            legend: { position: 'none' },
            vAxis: { minValue: 0 },
            hAxis: {
              gridlines: { color: 'transparent' },
              ticks: [
                {v: 00, f: '0:00'},
                {v: 01, f: ''},
                {v: 02, f: ''},
                {v: 03, f: ''},
                {v: 04, f: ''},
                {v: 05, f: ''},
                {v: 06, f: '6:00'},
                {v: 07, f: ''},
                {v: 08, f: ''},
                {v: 09, f: ''},
                {v: 10, f: ''},
                {v: 11, f: ''},
                {v: 12, f: '12:00'},
                {v: 13, f: ''},
                {v: 14, f: ''},
                {v: 15, f: ''},
                {v: 16, f: ''},
                {v: 17, f: ''},
                {v: 18, f: '18:00'},
                {v: 19, f: ''},
                {v: 20, f: ''},
                {v: 21, f: ''},
                {v: 22, f: ''},
                {v: 23, f: ''},
              ],
              slantedText: false,
            },
            series: {
              0: { type: 'line', color: '#4285F4' },
            },
            backgroundColor: 'transparent',
          };

          var chart = new google.visualization.LineChart(document.getElementById('grafico-attivita'));
          chart.draw(data, options);
        }
        */

        let target_user = get_cookie_by_name("username")
        managed = get_cookie_by_name("managed")
        if(!(managed === undefined))
          target_user = managed

        let all_info;
        $.ajax({
          type: 'POST',
          dataType: "json",
          async: false,
          url: `https://site212251.tw.cs.unibo.it/search`,
          headers: { },
          data: { query: target_user, tipo: 'utente', target: target_user },
          success: function (data, status, xhr) {
            all_info = data.post;
            console.log(all_info);
          }
        });

        var postData = [];
        var datiCommenti = [];
        var idSqueals = [];
        var corpoSqueals = [];

        for (const info of all_info) {
          if (info.timestamp) {
            postData.push(convertiTimestampInData(info.timestamp));
          }
          if (info.numRisposte) {
            datiCommenti.push(info.numRisposte);
          }
          if (info.post_id) {
            idSqueals.push(info.post_id);
          }
          if (info.corpo) {
            if (info.contenuto == 'testo') {
              corpoSqueals.push(info.corpo);
            } else {
              corpoSqueals.push('Immagine')
            }
          }
        }

        function getPreviousMonday(giorno) {
          date = new Date(giorno);
          var dayOfWeek = date.getDay(); // Ottieni il giorno della settimana (0 = Domenica, 1 = Lunedì, ..., 6 = Sabato)
          if (dayOfWeek == 1) {
            // La data fornita è già un lunedì, quindi la restituisci senza modificarla
            return date;
          } else {
            // Calcola quanti giorni devi retrocedere per raggiungere il lunedì precedente
            var daysToSubtract = (dayOfWeek == 0) ? 6 : dayOfWeek - 1;

            // Crea una copia della data fornita e sottrai i giorni necessari per ottenere il lunedì precedente
            var previousMonday = new Date(date);
            previousMonday.setDate(date.getDate() - daysToSubtract);

            return previousMonday;
          }
        }

        var startDate = new Date(postData[postData.length - 1]);
        var endDate = new Date(getPreviousMonday(postData[0]));

        var weeksData = [];
        while (startDate <= endDate) {
          var weekStart = new Date(startDate);
          var weekEnd = new Date(startDate);
          weekEnd.setDate(weekEnd.getDate() + 6);

          var weekLabel = weekStart.toLocaleDateString() + ' - ' + weekEnd.toLocaleDateString();
          weeksData.push({ week: weekLabel, start: weekStart, end: weekEnd });

          startDate.setDate(startDate.getDate() + 7);
        }


        // COMMENTI
        var corpoSquealsTagliati = corpoSqueals.map((frase) => {
          if (frase.length > 7) {
            return frase.slice(0, 7) + '...';
          }
          return frase;
        });

        datiCommenti = datiCommenti.slice(0, 5);
        corpoSquealsTagliati = corpoSquealsTagliati.slice(0,5);
        idSqueals = idSqueals.slice(0,5);

        // Ottieni il riferimento al canvas del grafico
        const canvasGraficoCommenti = document.getElementById("commentiChart");

        // Crea il grafico utilizzando Chart.js
        const graficoCommenti = new Chart(canvasGraficoCommenti, {
          type: "bar",
          data: {
            labels: corpoSquealsTagliati,
            datasets: [
              {
                label: "Numero di commenti ricevuti",
                data: datiCommenti,
                backgroundColor: "rgba(0, 102, 255, 0.3)",
                borderColor: "rgba(0, 102, 255, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
            plugins: {
              datalabels: {
                anchor: 'end',
                align: 'end',
                offset: 4,
                labels: {
                  title: {
                    font: {
                      weight: 'bold',
                    },
                  },
                },
              },
            },
            onClick: function (event, elements) {
              // Controllo se è stato cliccato un elemento del grafico
              if (elements.length > 0) {
                // Recupero l'indice dell'elemento cliccato
                const index = elements[0].index;

                // Recupero l'ID del squeal corrispondente all'indice
                const idSqueal = idSqueals[index];

                // Reindirizzo alla pagina desiderata usando l'ID del squeal
                ricerca_post(idSqueal);
              }
            },
          },
        });

        // POPOLARITA
        var datiPopolarita = [];
        var settPopolarita = [];

        $.ajax({
          type: 'GET',
          dataType: "json",
          async: false,
          url: `https://site212251.tw.cs.unibo.it/user_info?username=${target_user}`,
          headers: { },
          success: function (data, status, xhr) {
            datiPopolarita = data.popolarita.valori;
            settPopolarita = data.popolarita.settimane;
          }
        });

        // Ottieni il riferimento al canvas del grafico
        const canvasGraficoPopolarita = document.getElementById("popolaritaChart");

        // Crea il grafico a linea utilizzando Chart.js
        const graficoPopolarita = new Chart(canvasGraficoPopolarita, {
          type: "line", // Tipo di grafico (linea)
          data: {
            labels: settPopolarita,
            datasets: [
              {
                label: "Numero di Squeals popolari",
                data: datiPopolarita,
                borderColor: "rgba(0, 128, 0, 0.8)", // Colore della linea
                borderWidth: 2,
                fill: false, // Non riempire l'area sottostante la linea
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });

        //SQUEAL
        var postFrequenza = new Array(weeksData.length).fill(0); // Inizializza un array con zeri, uno per ogni settimana

        for (var i = 0; i < postData.length; i++) {
          var postDate = new Date(postData[i]);

          for (var j = 0; j < weeksData.length; j++) {
            var weekStart = weeksData[j].start;
            var weekEnd = weeksData[j].end;

            if (postDate >= weekStart && postDate <= weekEnd) {
              // Incrementa il conteggio di post per la settimana corrente
              postFrequenza[j]++;
            }
          }
        }


        // Ora postFrequenza è un array che contiene il numero di post per ciascuna settimana in weeksData

        // Continua con la creazione del grafico come nel tuo codice originale
        var canvas = document.getElementById('squealChart');
        var ctx = canvas.getContext('2d');

        var chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: weeksData.map(function (weekData) {
              var start = weekData.start.toLocaleDateString(undefined, { month: 'numeric', day: 'numeric' });
              var end = weekData.end.toLocaleDateString(undefined, { month: 'numeric', day: 'numeric' });
              return start + ' - ' + end;
            }),
            datasets: [{
              label: 'Numero di squeals postati',
              data: postFrequenza, // Utilizza il nuovo array postFrequenza
              borderColor: 'rgba(255, 139, 45, 1)',
              borderWidth: 2,
              fill: false,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                // Imposta il formato degli assi y come interi anziché con la virgola
                ticks: {
                  callback: function(value) {
                    return value.toFixed(0);
                  }
                }
              }
            }
          }
        });


        // TRENDS
        const pastelColors = [
          '#FF8080', '#FFB380', '#FFD480', '#FFFF80', '#BFFF80',
          '#80FF80', '#80FFBF', '#C0B3FF', '#CFAEFF'
        ];

        function getRandomPastelColor() {
          const randomIndex = Math.floor(Math.random() * pastelColors.length);
          return pastelColors[randomIndex];
        }

        // Crea le tessere del mosaico dinamicamente
        function createMosaicTiles() {
          const container = document.querySelector('.mosaic-container');
          const tileSize = 30; // Dimensione della tessera

          // Array dei trend
          var trends = ['#Trend1', '#prova', '#ciaociaociao', '#Trend4', '#squealer'];

          for (let i = 0; i < trends.length; i++) {
            const tile = document.createElement('a');
            tile.classList.add('mosaic-tile');
            tile.style.backgroundColor = getRandomPastelColor();
            tile.textContent = trends[i];
            tile.style.width = trends[i].length * 10 + 'px'; // Imposta la larghezza in base alla lunghezza della parola
            tile.style.height = tileSize + 'px';
            tile.href = '#'; // Imposta l'URL del link

            container.appendChild(tile);
          }
        }
        createMosaicTiles();

        var postLabels = ["Post 1", "Post 2", "Post 3", "Post 4", "Post 5"];
        var commentData = [10, 20, 15, 30, 25];

      </script>
  </body>
</html>
