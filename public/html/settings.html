<!DOCTYPE html>
<html lang="it">

<head>
  <title>Impostazioni - Squealer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <script src="https://kit.fontawesome.com/352b6e21d2.js" crossorigin="anonymous"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="../css/settings.css">
  <link rel="stylesheet" href="../css/navbar.css">

  <!--JavaScript Scripts-->
  <script type="text/javascript" src="/js/global.js"></script>
  <script type="text/javascript" src="/js/settings.js"></script>

</head>

<body>
  <header>
    <div class="navbar fixed-top">
      <div id="profile">
        <img src="https://via.placeholder.com/60x60" alt="Foto del tuo profilo" id="propic">
        <div class="dropdown" id="username">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <strong>
              <script>
                document.write(get_cookie_by_name("username"))
              </script>
            </strong>
          </button>
          <div disabled class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="dropdown-account-smm">
            <h6 class="dropdown-header">Gestisci altri account</h6>
          </div>
        </div>
        <div id="managed-account-username" class="btn btn-primary" hidden="true"></div>
      </div>
      <div id="quota" aria-label="Sezione quota">
        <div class="char-count-item" aria-label="Caratteri rimanenti questo mese">
          <span class="count" id="charCount_mese" aria-live="polite"></span>
          <span class="label">Mese</span>
        </div>
        <div class="char-count-item" aria-label="Caratteri rimanenti questa settimana">
          <span class="count" id="charCount_sett" aria-live="polite"></span>
          <span class="label">Settimana</span>
        </div>
        <div class="char-count-item" aria-label="Caratteri rimanenti oggi">
          <span class="count" id="charCount_giorno" aria-live="polite"></span>
          <span class="label">Giorno</span>
        </div>
        <button type="button" class="btn btn-unstyled" id="shopButton" data-bs-toggle="modal" data-bs-target="#shop-quota" aria-haspopup="true" title="compra più quota">
          <i class="fas fa-shopping-cart" aria-hidden="true"></i>
        </button>
      </div>
      <div class="lateral-buttons" aria-label="Bottoni laterali">
        <div id="home">
          <button type="button" class="btn btn-unstyled" id="homeButton" title="Home" onclick="redirectToHome()">
            <i class="fas fa-home"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Modal -->
  <div class="modal fade" id="shop-quota" tabindex="-1" role="dialog" aria-labelledby="shop-quota" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document"> <!-- Modal size changed to large (modal-lg) -->
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Acquista Quota</div>
          <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span> <!-- Changed to the "x" icon symbol -->
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-4">
              <div class="text-center"> <!-- Centered image and button -->
                <img src="https://site212251.tw.cs.unibo.it/uploads/compra_quota_120.png" alt="compra 120 caratteri per 0.99" class="img-fluid">
                <button onclick="compra_quota(120)" class="btn btn-primary mt-3">Acquista</button> <!-- Added margin top -->
              </div>
            </div>
            <div class="col-4">
              <div class="text-center">
                <img src="https://site212251.tw.cs.unibo.it/uploads/compra_quota_240.png" alt="compra 240 caratteri per 1.99" class="img-fluid">
                <button onclick="compra_quota(240)" class="btn btn-primary mt-3">Acquista</button>
              </div>
            </div>
            <div class="col-4">
              <div class="text-center">
                <img src="https://site212251.tw.cs.unibo.it/uploads/compra_quota_480.png" alt="compra 480 caratteri per 4.99" class="img-fluid">
                <button onclick="compra_quota(480)" class="btn btn-primary mt-3">Acquista</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="main">
    <!-- MENU -->
    <div id="sidebar">
      <ul id="menu">
        <li><button onclick="switch_settings('profilo')">Profilo</button></li>
        <li><button onclick="switch_settings('account')">Account</button></li>
        <li><button onclick="switch_settings('acquisti')">Storico Acquisti</button></li>
        <li><button onclick="switch_settings('smm')">Social Media Manager</button></li>
        <li><button onclick="switch_settings('follow')">Follow</button></li>
        <li><button onclick="switch_settings('popolarita')">Popolarità</button></li>
        <li><button onclick="switch_settings('canali')">Canali</button></li>
      </ul>
    </div>

    <!-- CONTENUTO -->
    <div id="content">

      <div id="profilo" class="sezione">
        <div class="container">
          <h3 class="mb-4 title-sezione">Impostazioni Informazioni Personali</h3>
          <form role="form" aria-label="Form impostazioni personali" id="form_info" class="ordine">

            <div class="col1">
              <div class="form-group">
                <label for="newName" class="label-form">Nome:</label>
                <input type="text" name="nome" class="form-control" id="newName" placeholder="Modifica" aria-label="Nome">
              </div>

              <div class="form-group">
                <label for="newSurname" class="label-form">Cognome: </label>
                <input type="text" name="cognome" class="form-control" id="newSurname" placeholder="Modifica" aria-label="Cognome">
              </div>

              <div class="form-group">
                <label for="newDesc" class="label-form">Descrizione: </label>
                <input type="text" name="bio" class="form-control" id="newDesc" placeholder="Modifica" aria-label="Descrizione">
              </div>
            </div>

            <div class="col2">
              <div class="form-group form-img">
                <label for="newImg" class="label-form" hidden>Immagine profilo: </label>
                <img alt="immagine profilo attuale" id="currentImg"></img>
                <input type="file" name="img" class="form-control" id="newImg" placeholder="Nuova immagine di profilo" accept="image/*" aria-label="Immagine">
              </div>

              <button type="submit" class="btn btn-primary">Salva</button>
            </div>
          </form>
        </div>
      </div>


      <div id="account" class="sezione">
        <div class="container">
        <h3 class="mb-4 title-sezione">Impostazioni mail e password</h3>
            <form role="form" aria-label="Form cambio mail o password" id="form_psw" class="ordine" onsubmit="return check_form()">
              <div class="col1">
              <div class="form-group">
                <label for="newEmail" class="label-form">Email: </label>
                <input type="text" name="email" class="form-control" id="newEmail" placeholder="Nuova email" aria-label="Email">
              </div>
          </div>
          <div class="col2">
            <div class="form-img">
              <div class="form-group">
                <label for="oldPassword" class="label-form">Password: </label>
                <input type="text" name="old_password" class="form-control" id="oldPassword" placeholder="Password" aria-label="Password attuale" required>
                <!-- <i class="far fa-eye" id="togglePassword" style="margin-left: -30px; cursor: pointer;"></i> -->
              </div>

              <div class="form-group">
                <label for="newPassword" class="label-form">Nuova password: </label>
                <input type="text" name="password" class="form-control" id="newPassword" placeholder="Nuova password" aria-label="Nuova password">
              </div>

              <div class="form-group">
                <label for="newCPassword" class="label-form">Conferma password: </label>
                <input type="text" name="c_password" class="form-control" id="newCPassword" placeholder="Conferma nuova password" aria-label="Conferma nuova password">
              </div>

            </div>

            <button type="submit" class="btn btn-primary">Salva</button>

          </div>

        </div>
        </form>
      </div>


      <div id="acquisti" class="sezione">
        <h2 class="mb-4 title-sezione">Storico Acquisti</h2>
        <div class="container">
                   <ul id="acquisti-list">
                       <!-- Gli acquisti saranno aggiunti dinamicamente qui tramite JavaScript -->
                   </ul>
               </div>
        </div>


      <div id="smm" class="sezione"> <!-- ACCOUNT GESTITI/SMM -->
        <div class="container">
          <div class="ordine">
            <div class="col1">
              <h3>I tuoi account gestiti</h3>
              <div id="div_account_gestiti"></div>
            </div>
            <div class="col2">
                <form id="update_smm" enctype="multipart/form-data" class="smm-ordine">
                  <div class="smm1">
                    <label for="current_smm">SMM che gestisce il tuo account:</label>
                    <input type="text" class="form-control" id="current_smm" name="current_smm" readonly>
                    <input type="submit" class="btn btn-danger" value="  Rimuovi  ">
                  </div>
                  <div class="smm2">
                    <label for="new_smm" hidden>Cambia SMM</label>
                    <input type="text" id="new_smm" class="form-control" name="new_smm" placeholder="Cambia SMM">
                    <input type="submit" class="btn btn-success" value="Conferma ">
                  </div>
                </form>
            </div>
          </div>
      </div>
      </div>


      <div id="follow" class="sezione">
        <div class="container">
          <h2 class="mb-4 title-sezione">Lista Followers e Seguiti</h2>

          <div class="ordine">
            <div class="col1">
              <h3>Followers</h3>
              <div class="followers">
                <ul class="follower-list-utenti barra-scorrimento">
                  <!-- Lista dei follower -->
                </ul>

              </div>
            </div>

            <div class="col2 smm-ordine">
              <h3>Seguiti</h3>
              <div class="followers">
                <div class="utenti">
                  <h4>Utenti</h4>
                  <ul class="follow-list-utenti barra-scorrimento">
                    <!-- Lista dei follower -->
                  </ul>
                </div>
                <div class="canali">
                  <h4>Canali</h4>
                  <ul class="follow-list-canali barra-scorrimento">
                    <!-- Lista dei follower -->
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="popolarita" class="sezione">
        <div class="container barra-scorrimento">
          <h2 class="mb-4 title-sezione">Popolarità</h2>
          <div class="previsione">
            <p>Previsione andamento popolarità:
              <div class="riquadro_popolarita">
                  <span>+20</span>
              </div>
            </p>
            <i class="fa-solid fa-right-long"></i>
            <div class="riquadro_quota">
                <span>+6</span><sub> caratteri al giorno</sub>
            </div>
          </div>
          <div class="ordine">
            <div class="colonna pop">
                <h3>Popolari  <span>n.0</span></h3>
                <div class="popolari barra-scorrimento">

                </div>
            </div>
            <div class="colonna impop">
                <h3>Impopolari  <span>n.0</span></h3>
                <div class="impopolari barra-scorrimento">

                </div>
            </div>
            <div class="colonna controv">
                <h3>Controversi  <span>n.0</span></h3>
                <div class="controversi barra-scorrimento">

                </div>
            </div>
          </div>
        </div>
      </div>

      <div id="canali" class="sezione">
        <div class="container barra-scorrimento">
          <h2 class="mb-4 title-sezione">Canali</h2>
          <div class="ordine">
            <div class="colonna pop">
                <h3>Canali gestiti</h3>
                <div id="canali_gestiti" class="popolari barra-scorrimento">

                </div>
            </div>
            <div class="colonna impop">
                <h3>Canali acquistati</h3>
                <div id="canali_acquistati" class="impopolari barra-scorrimento">

                </div>
            </div>
            <div>
                <div id="canale_selezionato" hidden="true">
                  <form id="form_modifica_canale">
                    <div id="canale_selezionato_nome"></div>
                    <img id="canale_selezionato_img">
                    <input type="file" id="new_img" name="img" accept="image/*">
                    <input type="textarea" id="new_descrizione">
                    <input type="textarea" id="modlist">
                    <input type="submit" value="Applica">
                  </form>
                </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous">
  </script>

  <script>
    // override funzione form update_smm
    document.getElementById("update_smm").addEventListener('submit', async event => {
      event.preventDefault();
      update_smm();
    });

    // override funzione form modifica canale
    document.getElementById("form_modifica_canale").addEventListener('submit', async event => {
      event.preventDefault();
      update_channel();
    });

    // INSERIMENTO PROPIC UTENTE
    $("#propic").attr("src", "https://site212251.tw.cs.unibo.it/uploads/" + get_cookie_by_name("img"))

    // controllo l'account corrente (gestione smm)
    var CURRENT_USER = get_cookie_by_name("managed");
    if (CURRENT_USER == undefined) {
      CURRENT_USER = get_cookie_by_name("username");
    }

    //azione post form info utente
    //$("#form_info").attr("action", `/user/${CURRENT_USER}/settings`)
    document.getElementById("form_info").addEventListener('submit', async event => {
      event.preventDefault();
      form_info();
    });

    //azione post form psw utente
    //$("#form_psw").attr("action", `/user/${CURRENT_USER}/settings`)
    document.getElementById("form_psw").addEventListener('submit', async event => {
      event.preventDefault();
      form_psw();
    });

    //password show/hide
    /*
    const togglePassword = document.querySelector('#togglePassword');
    const password = document.querySelector('#oldPassword');

    togglePassword.addEventListener('click', function (e) {
      // toggle the type attribute
      const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
      password.setAttribute('type', type);
      // toggle the eye slash icon
      this.classList.toggle('fa-eye-slash');
    });
    */

    // aggiorno la quota
    refresh_quota()
    let quota_giorno = get_cookie_by_name("quota_g");
    let quota_settimana = get_cookie_by_name("quota_s");
    let quota_mese = get_cookie_by_name("quota_m");

    // Aggiorna il contenuto delle span con i nuovi valori
    document.getElementById("charCount_mese").textContent = quota_mese;
    document.getElementById("charCount_sett").textContent = quota_settimana;
    document.getElementById("charCount_giorno").textContent = quota_giorno;

    function compra_quota(qnt) {
      let data = { "target": CURRENT_USER, "qnt": qnt, "acquisto": true }

      fetch("/user/" + CURRENT_USER + "/quota", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then((response) => {
          //chiudo modal
          $("#shop-quota").modal("toggle")
          let new_quota = parseInt(get_cookie_by_name("quota_g")) + qnt
          //aggiorno il cookie quota
          set_cookie("quota_g", new_quota)
          //aggiorno navbar
          $("#charCount_giorno").text(new_quota)
        })
    }

    // ================= SEZIONI
    let all_info;
    $.ajax({
      type: 'POST',
      dataType: "json",
      async: false,
      url: `https://site212251.tw.cs.unibo.it/squeal/by_user`,
      headers: { },
      data: { query: CURRENT_USER, target: CURRENT_USER },
      success: function (data, status, xhr) {
        console.log('data: ', data);
        all_info = data.data;
      }
    });
    if (all_info === undefined) {
      console.log("error");
    }

    // === PROFILO
    let NomeCognome = all_info.meta.info.nome;
    let ArrayCName = NomeCognome.split(' ');
    document.getElementById("currentImg").src = "https://site212251.tw.cs.unibo.it/uploads/" + all_info.meta.info.img;

    document.getElementById("newName").value = ArrayCName[0];
    document.getElementById("newSurname").value = ArrayCName[1];
    document.getElementById("newDesc").value = all_info.meta.info.bio;

    // === ACCOUNT
    document.getElementById("newEmail").value = all_info.meta.info.email;

    // === SMM

    //tuoi account gestiti
    let account = []
    $.ajax({
      type: 'GET',
      dataType: "json",
      async: false,
      url: `https://site212251.tw.cs.unibo.it/user/${CURRENT_USER}/manager_of`,
      headers: { },
      success: function (data, status, xhr) {
        console.log('data: ', data);
        account = data["data"];
      }
    });

    if(account.length > 0){
      let tmp = "<ul id='lista_account_gestiti'>"
      account.forEach((el) => {
        tmp += `<li>${el}</li>`
      })
      tmp += "</ul>"
      $("#div_account_gestiti").append(tmp)

    } else {
      $("#div_account_gestiti").text("Non gestisci nessun account")
    }

    //tuo smm
    let result = null
    $.ajax({
      type: 'GET',
      dataType: "json",
      async: false,
      url: `https://site212251.tw.cs.unibo.it/user/${CURRENT_USER}/managed_by`,
      headers: { },
      success: function (data, status, xhr) {
        console.log('data: ', data);
        result = data["data"];
      }
    });

    if(result == null){
      $("#current_smm").attr("value", "Non ci sono SMM che gestiscono il tuo account")
    } else {
      $("#current_smm").attr("value", result)
    }

    // STORICO ACQUISTI
    document.addEventListener('DOMContentLoaded', function() {
        // Effettua la chiamata API per ottenere le informazioni sull'utente
        fetch(`/user/${CURRENT_USER}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.risultato === 'successo') {
                    // L'utente è stato trovato, puoi accedere agli acquisti
                    var acquisti = data.data.acquisti;
                    popolaListaAcquisti(acquisti);
                } else {
                    // L'utente non è stato trovato o si è verificato un altro errore
                    console.error('Errore nel recupero delle informazioni utente:', data.errore);
                }
            })
            .catch(error => {
                console.error('Si è verificato un errore nella richiesta:', error);
            });
    });

    // Funzione per popolare dinamicamente la lista degli acquisti nella pagina HTML
    function popolaListaAcquisti(acquisti) {
        var acquistiList = document.getElementById('acquisti-list');

        // Popola la lista degli acquisti
        acquisti.forEach(function(acquisto) {
            var listItem = document.createElement('li');
            listItem.innerHTML = `
                <div class="acquisto">
                    <div class="info">
                        <div class="quantita">Quota aggiunta: <span class="numero">${acquisto.quantita}</span> <span class="caratteri">caratteri</span></div>
                        <div class="timestamp"><i class="fas fa-calendar"></i> ${timeConverter(acquisto.timestamp)}</div>
                    </div>
                    <div class="spesa">
                        <i class="fas fa-shopping-cart"></i>
                        <div class="ammontare">${calcolaAmmontare(acquisto.quantita)} €</div>
                    </div>
                </div>
            `;
            acquistiList.appendChild(listItem);
        });
    }

    function calcolaAmmontare(quantita) {
        if (quantita === 120) {
            return '0,99';
        } else if (quantita === 240) {
            return '1,99';
        } else if (quantita === 480) {
            return '4,99';
        } else {
            return '';
        }
    }


    //follower e follow
    let follow = []
    $.ajax({
      type: 'GET',
      dataType: "json",
      async: false,
      url: `https://site212251.tw.cs.unibo.it/user/${CURRENT_USER}`,
      headers: { },
      success: function (data, status, xhr) {
        console.log('data: ', data);
        follow = data["data"];
        let follow_utenti = follow.utenti_seguiti
        let follow_canali = follow.canali_seguiti
        console.log(follow_utenti);
        popolaSeguiti(follow_utenti, follow_canali);
      }
    });

    $.ajax({
      type: 'GET',
      dataType: "json",
      async: false,
      url: `https://site212251.tw.cs.unibo.it/user/${CURRENT_USER}/followers`,
      headers: { },
      success: function (data, status, xhr) {
        console.log('data: ', data);
        follower = data["data"];
        let followers = follower
        popolaFollowers(followers);
      }
    });


    function popolaFollowers(followers) {
      var followerlist = document.querySelector(".follower-list-utenti");

      for (var i = 0; i < followers.length; i++) {
        var utente = followers[i].username;
        var listItem = document.createElement("li");
        listItem.setAttribute("data-id", utente);
        listItem.innerHTML = `
          <div>
            <i class="fas fa-user"></i>
            <span>${utente}</span>
          </div>
          <button class="remove-btn" onclick="removeFollowing('${utente}', 'utente')">
            <i class="fa-solid fa-x"></i>
          </button>
        `;
        followerlist.appendChild(listItem);
      }
    }

    function popolaSeguiti(follow_utenti, follow_canali) {
      // Popola la lista degli utenti seguiti
      var followListUtenti = document.querySelector(".follow-list-utenti");
      var followListCanali = document.querySelector(".follow-list-canali");

      for (var i = 0; i < follow_utenti.length; i++) {
        var utente = follow_utenti[i];
        var listItem = document.createElement("li");
        listItem.setAttribute("data-id", utente);
        listItem.innerHTML = `
          <div>
            <i class="fas fa-user"></i>
            <span>${utente}</span>
          </div>
          <button class="remove-btn" onclick="removeFollowing('${utente}', 'utente')">
            <i class="fa-solid fa-x"></i>
          </button>
        `;
        followListUtenti.appendChild(listItem);
      }

      for (var j = 0; j < follow_canali.length; j++) {
        var canale = follow_canali[j];
        var listItemCanale = document.createElement("li");
        listItem.setAttribute("data-id", canale);
        listItemCanale.innerHTML = `
          <div>
            <i class="fas fa-users"></i>
            <span>${canale}</span>
          </div>
          <button class="remove-btn" onclick="removeFollowing('${canale}', 'canale')">
            <i class="fa-solid fa-x"></i>
          </button>
        `;
        followListCanali.appendChild(listItemCanale);
      }
    }

              function removeFollowing(target, tipo){
                console.log(target);
                console.log(tipo);

                $.ajax({
                  type: 'POST',
                  dataType: "json",
                  url: `https://site212251.tw.cs.unibo.it/user/${CURRENT_USER}/follow`,
                  headers: { },
                  data: { target: target, tipo: tipo },
                  success: function (data, status, xhr) {
                     // Cerco e rimuovo l'elemento dalla lista
                     var elemento = $(`.follower-list li[data-id="'${target}'"]`);
                     elemento.remove();
                   }
                  }
                });
              }


              //Popolarita
              let all_post;
              $.ajax({
                type: 'POST',
                dataType: "json",
                async: false,
                url: `https://site212251.tw.cs.unibo.it/squeal/by_user`,
                headers: { },
                data: { query: CURRENT_USER, target: CURRENT_USER },
                success: function (data, status, xhr) {
                  all_post = data.data.post;
                }
              });

              var num_popolari = 0;
              var num_impopolari = 0;
              var num_controversi = 0;

              for (var i = 0; i < all_post.length; i++) {
                var container_popolare = document.querySelector(".popolari");
                var container_impopolare = document.querySelector(".impopolari");
                var container_controverso = document.querySelector(".controversi");

                if (all_post[i].categoria == 'popolare') {
                  num_popolari++;
                  var nuovoElemento = document.createElement("div");
                  nuovoElemento.classList.add("squeal");
                  var nuovoContenuto = `
                      <div class="squeal-header">
                          <img src="https://site212251.tw.cs.unibo.it/uploads/${all_post[i].img}" alt="Immagine Profilo" class="squeal-immagine-profilo" id="squeal-immagine-profilo">
                          <div class="squeal-info">
                              <span class="squeal-nome-utente" id="squeal-nome-utente">${all_post[i].nome}</span>
                              <span class="squeal-data" id="squeal-data">${timeConverter(all_post[i].timestamp)}</span>
                          </div>
                      </div>
                      <div class="squeal-contenuto" id="squeal-contenuto">
                          {{contenuto}}
                      </div>
                  `;

                  if (all_post[i].contenuto == "testo") {
                      nuovoContenuto = nuovoContenuto.replace("{{contenuto}}", all_post[i].corpo);
                  } else if (all_post[i].contenuto == "img") {
                      nuovoContenuto = nuovoContenuto.replace("{{contenuto}}", `<img src="https://site212251.tw.cs.unibo.it/uploads/${all_post[i].corpo}" alt="immagine_squeal">`);
                  }

                  // Imposta il contenuto HTML della nuova div
                  nuovoElemento.innerHTML = nuovoContenuto;
                  // Aggiungi la nuova div all'elemento container
                  container_popolare.appendChild(nuovoElemento);

                } else if (all_post[i].categoria == 'impopolare') {
                  num_impopolari++;
                  var nuovoElemento = document.createElement("div");
                  nuovoElemento.classList.add("squeal");
                  var nuovoContenuto = `
                      <div class="squeal-header">
                          <img src="https://site212251.tw.cs.unibo.it/uploads/${all_post[i].img}" alt="Immagine Profilo" class="squeal-immagine-profilo" id="squeal-immagine-profilo">
                          <div class="squeal-info">
                              <span class="squeal-nome-utente" id="squeal-nome-utente">${all_post[i].nome}</span>
                              <span class="squeal-data" id="squeal-data">${timeConverter(all_post[i].timestamp)}</span>
                          </div>
                      </div>
                      <div class="squeal-contenuto" id="squeal-contenuto">
                          {{contenuto}}
                      </div>
                  `;

                  if (all_post[i].contenuto == "testo") {
                      nuovoContenuto = nuovoContenuto.replace("{{contenuto}}", all_post[i].corpo);
                  } else if (all_post[i].contenuto == "img") {
                      nuovoContenuto = nuovoContenuto.replace("{{contenuto}}", `<img src="https://site212251.tw.cs.unibo.it/uploads/${all_post[i].corpo}" alt="immagine_squeal">`);
                  }

                  // Imposta il contenuto HTML della nuova div
                  nuovoElemento.innerHTML = nuovoContenuto;
                  // Aggiungi la nuova div all'elemento container
                  container_impopolare.appendChild(nuovoElemento);

                }else if (all_post[i].categoria == 'controverso') {
                  num_controversi++;
                  var nuovoElemento = document.createElement("div");
                  nuovoElemento.classList.add("squeal");
                  var nuovoContenuto = `
                      <div class="squeal-header">
                          <img src="https://site212251.tw.cs.unibo.it/uploads/${all_post[i].img}" alt="Immagine Profilo" class="squeal-immagine-profilo" id="squeal-immagine-profilo">
                          <div class="squeal-info">
                              <span class="squeal-nome-utente" id="squeal-nome-utente">${all_post[i].nome}</span>
                              <span class="squeal-data" id="squeal-data">${timeConverter(all_post[i].timestamp)}</span>
                          </div>
                      </div>
                      <div class="squeal-contenuto" id="squeal-contenuto">
                          {{contenuto}}
                      </div>
                  `;

                  if (all_post[i].contenuto == "testo") {
                      nuovoContenuto = nuovoContenuto.replace("{{contenuto}}", all_post[i].corpo);
                  } else if (all_post[i].contenuto == "img") {
                      nuovoContenuto = nuovoContenuto.replace("{{contenuto}}", `<img src="https://site212251.tw.cs.unibo.it/uploads/${all_post[i].corpo}" alt="immagine_squeal">`);
                  }

                  // Imposta il contenuto HTML della nuova div
                  nuovoElemento.innerHTML = nuovoContenuto;
                  // Aggiungi la nuova div all'elemento container
                  container_controverso.appendChild(nuovoElemento);

                }
              }
              // aggiunta numero effettivo squeal
              var numero_popolari = document.querySelector('.colonna.pop h3 span');
              var numero_impopolari = document.querySelector('.colonna.impop h3 span');
              var numero_controversi = document.querySelector('.colonna.controv h3 span');

              // Aggiorna il contenuto con il numero effettivo
              numero_popolari.textContent = 'n.' + num_popolari;
              numero_impopolari.textContent = 'n.' + num_impopolari;
              numero_controversi.textContent = 'n.' + num_controversi;

              //gestione popolarità e quota
              let pop = num_popolari - num_impopolari;
              let bonus = (Math.floor(pop / 10) / 100) * 300 //1% +- per ogni 10 di popolarita

              // Aggiorna il contenuto del riquadro popolarita
              var val_popolarita = document.querySelector('.riquadro_popolarita span');
              var riquadro_popolarita = document.querySelector('.riquadro_popolarita');

              if (pop >= 0) {
                val_popolarita.textContent = '+' + pop;
                riquadro_popolarita.style.backgroundColor = '#4caf50';
              } else {
                val_popolarita.textContent = pop;
                riquadro_popolarita.style.backgroundColor = '#FF6347';
                riquadro_popolarita.style.color = 'black';
              }

              // Aggiorna il contenuto del riquadro quota
              var val_quota = document.querySelector('.riquadro_quota span');
              var riquadro_quota = document.querySelector('.riquadro_quota');

              if (bonus >= 0) {
                val_quota.textContent = '+' + bonus;
                riquadro_quota.style.backgroundColor = '#42a5f5';
              } else {
                val_quota.textContent = bonus;
                riquadro_quota.style.backgroundColor = '#ffd966';
                riquadro_quota.style.color = 'black';
              }

    function previewImage(input) {
   var file = input.files[0];
   if (file) {
     var reader = new FileReader();
     reader.onload = function(e) {
       $('#currentImg').attr('src', e.target.result);
     };
     reader.readAsDataURL(file);
   }
 }

  let canali = []
  $.ajax({
    type: 'GET',
    dataType: "json",
    async: false,
    url: `https://site212251.tw.cs.unibo.it/user/${CURRENT_USER}/my_channels`,
    headers: { },
    success: function (data, status, xhr) {
      canali = data.data;
    }
  });
  canali.forEach((el) => {
    if(el.ruolo === "proprietario"){
      $("#canali_acquistati").append(`<div class="squeal"><img style="width: 60px; height: 60px" src="https://site212251.tw.cs.unibo.it/uploads/${el.img}" alt="immagine canale"><p>${el.canale}</p><p>Ruolo: ${el.ruolo}</p><button onclick="seleziona_canale('${el.canale}')">Modifica</button></div>`)
    } else if(el.ruolo === "mod"){
      $("#canali_gestiti").append(`<div class="squeal"><img style="width: 60px; height: 60px" src="https://site212251.tw.cs.unibo.it/uploads/${el.img}" alt="immagine canale"><p>${el.canale}</p><p>Ruolo: ${el.ruolo}</p></div>`)
    }
  })

  </script>
</body>

</html>
