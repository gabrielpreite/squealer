<!DOCTYPE html>
<html lang="it">

<head>
  <title>Impostazioni - Squealer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <script src="https://kit.fontawesome.com/352b6e21d2.js" crossorigin="anonymous"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="../css/settings.css">
  <link rel="stylesheet" href="../css/navbar.css">
  <link rel="stylesheet" href="../css/feed.css">

  <!--JavaScript Scripts-->
  <script type="text/javascript" src="/js/global.js"></script>
  <script type="text/javascript" src="/js/settings.js"></script>

</head>

<body>
  <header>
    <div class="navbar fixed-top">
      <div id="profile">
        <img src="https://via.placeholder.com/60x60" alt="Foto del tuo profilo" id="propic">
        <div class="dropdown" id="username">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <strong>
              <script>
                document.write(get_cookie_by_name("username"))
              </script>
            </strong>
          </button>
          <div disabled class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="dropdown-account-smm">
            <h6 class="dropdown-header">Gestisci altri account</h6>
          </div>
        </div>
        <div id="managed-account-username" class="btn btn-primary" hidden="true"></div>
      </div>
      <div id="quota">
        <div class="char-count-item">
          <span class="count" id="charCount_mese">

          </span>
          <span class="label">Mese</span>
        </div>
        <div class="char-count-item">
          <span class="count" id="charCount_sett">

          </span>
          <span class="label">Settimana</span>
        </div>
        <div class="char-count-item">
          <span class="count" id="charCount_giorno">

          </span>
          <span class="label">Giorno</span>
        </div>
        <button type="button" class="btn btn-unstyled" id="shopButton" data-bs-toggle="modal"
          data-bs-target="#shop-quota">
          <i class="fas fa-shopping-cart"></i>
        </button>
      </div>
      <div class="lateral-buttons">
        <div id="notifiche">
          <button class="btn btn-unstyled" id="notificationsButton" data-bs-toggle="dropdown" aria-haspopup="true"
            aria-expanded="false">
            <i class="fas fa-bell"></i>
          </button>
          <div class="dropdown-menu dropdown-menu-end" id="notificationsDropdown" aria-labelledby="notificationsButton">
            <h3 class="dropdown-header">Notifiche</h3>
            <a class="dropdown-item" href="#">Notifica 1</a>
            <a class="dropdown-item" href="#">Notifica 2</a>
            <a class="dropdown-item" href="#">Notifica 3</a>
            <!-- Aggiungi altre notifiche qui -->
          </div>


        </div>
        <div id="home">
          <button class="btn btn-unstyled" id="homeButton" onclick="redirectToHome()">
            <i class="fas fa-home"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Modal -->
  <div class="modal fade" id="shop-quota" tabindex="-1" role="dialog" aria-labelledby="shop-quota" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document"> <!-- Modal size changed to large (modal-lg) -->
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Acquista Quota</div>
          <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span> <!-- Changed to the "x" icon symbol -->
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-4">
              <div class="text-center"> <!-- Centered image and button -->
                <img src="https://site212251.tw.cs.unibo.it/uploads/compra_quota_120.png" alt="compra 120 caratteri per 0.99" class="img-fluid">
                <button onclick="compra_quota(120)" class="btn btn-primary mt-3">Acquista</button> <!-- Added margin top -->
              </div>
            </div>
            <div class="col-4">
              <div class="text-center">
                <img src="https://site212251.tw.cs.unibo.it/uploads/compra_quota_240.png" alt="compra 240 caratteri per 1.99" class="img-fluid">
                <button onclick="compra_quota(240)" class="btn btn-primary mt-3">Acquista</button>
              </div>
            </div>
            <div class="col-4">
              <div class="text-center">
                <img src="https://site212251.tw.cs.unibo.it/uploads/compra_quota_480.png" alt="compra 480 caratteri per 4.99" class="img-fluid">
                <button onclick="compra_quota(480)" class="btn btn-primary mt-3">Acquista</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="main">
    <!-- MENU -->
    <div id="sidebar">
      <ul id="menu">
        <li><button class="btn btn-outline-primary" onclick="switch_settings('profilo')">Profilo</button></li>
        <li><button class="btn btn-outline-primary" onclick="switch_settings('account')">Account</button></li>
        <li><button class="btn btn-outline-primary" onclick="switch_settings('acquisti')">Storico Acquisti</button></li>
        <li><button class="btn btn-outline-primary" onclick="switch_settings('smm')">Gestione SMM</button></li>
        <li><button class="btn btn-outline-primary" onclick="switch_settings('follow')">Follow</button></li>
        <li><button class="btn btn-outline-primary" onclick="switch_settings('popolarita')">Popolarit√†</button></li>
      </ul>
    </div>

    <!-- CONTENUTO -->
    <div id="content">
      <div id="profilo">
        <h2 class="mb-4">Impostazioni Informazioni Personali</h2>

        <form role="form" aria-labelledby="Form impostazioni personali">
          <div class="form-group">
            <label for="newName" class="label-form">Nome: </label>
            <label for="currentName" id="currentName">nome</label>
            <input type="text" class="form-control" id="newName" placeholder="Cambia il tuo nome" aria-label="Nome">
          </div>

          <div class="form-group">
            <label for="newSurname" class="label-form">Cognome: </label>
            <label for="currentSurname" id="currentSurname">cognome</label>
            <input type="text" class="form-control" id="newSurname" placeholder="Cambia il tuo cognome" aria-label="Cognome">
          </div>

          <div class="form-group">
            <label for="newDesc" class="label-form">Descrizione: </label>
            <label for="currentDesc" id="currentDesc">desc</label>
            <input type="text" class="form-control" id="newDesc" placeholder="Cambia la tua descrizione" aria-label="Descrizione">
          </div>

          <div class="form-group">
            <label for="newImg" class="label-form">Immagine profilo: </label>
            <img alt="immagine profilo attuale" id="currentImg">img</img>
            <input type="text" class="form-control" id="inputName" placeholder="Cambia la tua immagine di profilo" aria-label="Immagine">
          </div>
      
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
      <div id="account" >
        TODO - cambia mail/pwd con verifica pwd
      </div>
      <div id="acquisti" >
         <h1>Storico Acquisti<h1>
        <ul id="acquisti-list">
            <!-- Gli acquisti saranno aggiunti dinamicamente qui tramite JavaScript -->
        </ul>
      </div>

      <div id="smm" > <!-- ACCOUNT GESTITI/SMM -->
        <h3>I tuoi account gestiti</h3>
        <div id="div_account_gestiti"></div>

        <form id="update_smm" enctype="multipart/form-data">
          <h3>SMM che gestisce il tuo account</h3>
          <input type="text" id="current_smm" name="current_smm" readonly>
          <input type="submit" class="btn btn-danger" value="Rimuovi SMM">
          <h5>Aggiungi/cambia SMM</h5>
          <input type="text" id="new_smm" name="new_smm">
          <input type="submit" value="Conferma">
        </form>

      </div>
      <div id="follow" >
        TODO - lista account/pagine seguite + tuoi followers (+ suggeriti?)
      </div>
      <div id="popolarita" >
        TODO - lista post pop/impop/contr + previsione andamento quota (+ grafico?)
      </div>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous">
  </script>

  <script>
    // override funzione form update_smm
    document.getElementById("update_smm").addEventListener('submit', async event => {
      event.preventDefault();
      update_smm();
    });


    // INSERIMENTO PROPIC UTENTE
    $("#propic").attr("src", "https://site212251.tw.cs.unibo.it/uploads/" + get_cookie_by_name("img"))

    // controllo l'account corrente (gestione smm)
    var CURRENT_USER = get_cookie_by_name("managed");
    if (CURRENT_USER == undefined) {
      CURRENT_USER = get_cookie_by_name("username");
    }

    // aggiorno la quota
    refresh_quota()
    let quota_giorno = get_cookie_by_name("quota_g");
    let quota_settimana = get_cookie_by_name("quota_s");
    let quota_mese = get_cookie_by_name("quota_m");

    // Aggiorna il contenuto delle span con i nuovi valori
    document.getElementById("charCount_mese").textContent = quota_mese;
    document.getElementById("charCount_sett").textContent = quota_settimana;
    document.getElementById("charCount_giorno").textContent = quota_giorno;

    function compra_quota(qnt) {
      let data = { "target": CURRENT_USER, "qnt": qnt, "acquisto": true }

      fetch("/user/" + CURRENT_USER + "/quota", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then((response) => {
          //chiudo modal
          $("#shop-quota").modal("toggle")
          let new_quota = parseInt(get_cookie_by_name("quota_g")) + qnt
          //aggiorno il cookie quota
          set_cookie("quota_g", new_quota)
          //aggiorno navbar
          $("#charCount_giorno").text(new_quota)
        })
    }

    // ================= SEZIONI
    let all_info;
    $.ajax({
      type: 'POST',
      dataType: "json",
      async: false,
      url: `https://site212251.tw.cs.unibo.it/squeal/by_user`,
      headers: { },
      data: { query: CURRENT_USER, target: CURRENT_USER },
      success: function (data, status, xhr) {
        console.log('data: ', data);
        all_info = data.data;
      }
    });
    if (all_info === undefined) {
      console.log("error");
    }

    // === PROFILO
    let NomeCognome = all_info.meta.info.nome;
    let ArrayCName = NomeCognome.split(' ');
    document.getElementById("currentName").innerHTML = ArrayCName[0];
    document.getElementById("currentSurname").innerHTML = ArrayCName[1];
    document.getElementById("currentDesc").innerHTML = all_info.meta.info.bio;
    document.getElementById("currentImg").innerHTML = all_info.meta.info.img;

    // === SMM

    //tuoi account gestiti
    let account = []
    $.ajax({
      type: 'GET',
      dataType: "json",
      async: false,
      url: `https://site212251.tw.cs.unibo.it/user/${CURRENT_USER}/manager_of`,
      headers: { },
      success: function (data, status, xhr) {
        console.log('data: ', data);
        account = data["data"];
      }
    });

    if(account.length > 0){
      let tmp = "<ul id='lista_account_gestiti'>"
      account.forEach((el) => {
        tmp += `<li>${el}</li>`
      })
      tmp += "</ul>"
      $("#div_account_gestiti").append(tmp)

    } else {
      $("#div_account_gestiti").text("Non gestisci nessun account")
    }

    //tuo smm
    let result = null
    $.ajax({
      type: 'GET',
      dataType: "json",
      async: false,
      url: `https://site212251.tw.cs.unibo.it/user/${CURRENT_USER}/managed_by`,
      headers: { },
      success: function (data, status, xhr) {
        console.log('data: ', data);
        result = data["data"];
      }
    });

    if(result == null){
      $("#current_smm").attr("value", "Non ci sono SMM che gestiscono il tuo account")
    } else {
      $("#current_smm").attr("value", result)
    }
  </script>
</body>

</html>
